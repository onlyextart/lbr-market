(function(e){e.fn.extend({BlackAndWhite:function(t){"use strict";var n=this,r=e.extend({hoverEffect:true,webworkerPath:false,invertHoverEffect:false,speed:500,onImageReady:null,intensity:1},t),i=r.hoverEffect,s=r.webworkerPath,o=r.invertHoverEffect,u=typeof r.intensity==="number"&&r.intensity<1&&r.intensity>0?r.intensity:1,a=e.isPlainObject(r.speed)?r.speed.fadeIn:r.speed,f=e.isPlainObject(r.speed)?r.speed.fadeOut:r.speed,l=e(window),c=50,h=120,p=".BlackAndWhite",d=document.all&&!window.opera&&window.XMLHttpRequest?true:false,v=" -webkit- -moz- -o- -ms- ".split(" "),m={},g=function(e){if(m[e]||m[e]===""){return m[e]+e}var t=document.createElement("div"),n=["","Moz","Webkit","O","ms","Khtml"];for(var r in n){if(typeof t.style[n[r]+e]!=="undefined"){m[e]=n[r];return n[r]+e}}return e.toLowerCase()},y=function(){var e=document.createElement("div");e.style.cssText=v.join("filter"+":blur(2px); ");return!!e.style.length&&(document.documentMode===undefined||document.documentMode>9)}(),b=!!document.createElement("canvas").getContext,w=function(){return typeof Worker!=="undefined"?true:false}(),E=g("Filter"),S=[],x=w&&s?new Worker(s+"BnWWorker.js"):false,T=function(t){e(t.currentTarget).find(".BWfade").stop(true,true).animate({opacity:o?0:1},f)},N=function(t){e(t.currentTarget).find(".BWfade").stop(true,true).animate({opacity:o?1:0},f)},C=function(e){if(typeof r.onImageReady==="function"){r.onImageReady(e)}},k=function(e){if(x&&b&&!y&&!e){L()}},L=function(){if(!S.length){if(x.terminate){x.terminate()}if(x.close){x.close()}return}x.postMessage({imgData:S[0].imageData,intensity:u});x.onmessage=function(e){S[0].ctx.putImageData(e.data,0,0);C(S[0].img);S.splice(0,1);L()}},A=function(e){return e.complete||typeof e.naturalWidth!=="undefined"&&e.naturalWidth},O=function(e,t,n,r){var i=t.getContext("2d"),s=e,o=0,a;i.drawImage(e,0,0,n,r);var f=i.getImageData(0,0,n,r),l=f.data,c=l.length;if(x){S.push({imageData:f,ctx:i,img:e})}else{for(;o<c;o+=4){var h=l[o]*.3+l[o+1]*.59+l[o+2]*.11;l[o]=~~(h*u+l[o]*(1-u));l[o+1]=~~(h*u+l[o+1]*(1-u));l[o+2]=~~(h*u+l[o+2]*(1-u))}i.putImageData(f,0,0);C(e)}},M=function(t,n){var r=t[0],i=r.src,s=t.position(),a={top:s.top,left:s.left,position:"absolute","-webkit-transform":"translate3d(0,0,0)",opacity:o?0:1},f;r.crossOrigin="anonymous";if(b&&!y){var l="";f=e('<canvas width="'+r.naturalWidth+'" height="'+r.naturalHeight+'" class="BWfade"></canvas>');a.width=t.width();a.height=t.height();O(r,f.get(0),r.naturalWidth,r.naturalHeight)}else{a[E]="grayscale("+u*100+"%)";f=t.clone().addClass("BWFilter BWfade");C(r)}f.css(e.extend(a,{filter:"progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"})).prependTo(n);if(!e.support.opacity&&o){f.animate({opacity:0},0)}},_=function(){n.each(function(t,n){var r=e(n).find("img"),i=e(r).width(),s=e(r).height();e(this).find("canvas").css({width:i,height:s})})},D=function(){var t=n.find("img").filter(function(){return!e(this).data("_b&w")}).length;n.each(function(n,r){var i=e(r),s=i.find("img");if(s.data("_b&w")){return}if(!A(s[0])){s.on("load",function(){if(s.data("_b&w_loaded")||!s[0].complete){setTimeout(function(){s.load()},20);return}M(s,i);s.data("_b&w_loaded",true);t--;k(t)}).load()}else{t--;M(s,i)}s.data("_b&w",true)});k(t);if(i){n.unbind(p).on("mouseleave"+p,T).on("mouseenter"+p,N)}if(b&&!y){l.unbind(p).on("resize"+p+" orientationchange"+p,_)}};var P=function(){n.off(p);l.off(p)};D();return{destroy:P}}})})(jQuery)